import preferences from '@ohos.data.preferences'
import util from '@ohos.util'
import promptAction from '@ohos.promptAction'
import http from '@ohos.net.http'
import notificationManager from '@ohos.notificationManager'
import wantAgent from '@ohos.app.ability.wantAgent'
@Entry
@Component
struct WeChat {
  myHttp: http.HttpRequest = http.createHttp()
  @State
  contentStr: string = "" // ç”¨æ¥è®°å½•æˆ‘ä»¬çš„è¾“å…¥å†…å®¹
  messStore: MessageStore = new MessageStore()
  @State
  topY: number = 0
  @State
  @Watch("updateMessage")
  messList: MessageItem[] = []
  // è·å–ä¸€ä¸‹é¦–é€‰é¡¹çš„æ•°æ®
  aboutToAppear() {
    this.getMess()
  }
  // å†™å…¥é¦–é€‰é¡¹
  updateMessage () {
    this.messStore.setMessageList(JSON.stringify(this.messList))
  }
  async getMess () {
   this.messList = await this.messStore.getMessageList()
  }
  // å‘é€æ¶ˆæ¯çš„æ–¹æ³•
  async sendMessage () {
    // 1.å°†å½“å‰çš„ç”¨æˆ·çš„æ¶ˆæ¯åŠ å…¥åˆ°æ¶ˆæ¯åˆ—è¡¨ä¸­
    let selfMessage: MessageItem = {
      avatar: $r("app.media.my"),
      username: 'è€é«˜',
      content: this.contentStr,
      timestamp: Date.now(),
      self: true,
      id: util.generateRandomUUID()
    }
    this.messList.push(selfMessage) // æ•°ç»„ä¼šæ›´æ–° => é¦–é€‰é¡¹
    // 2. å‘è¯·æ±‚this.contentStr}
    const url = `http://api.qingyunke.com/api.php?key=free&appid=0&msg=${encodeURI(this.contentStr)}`
    this.contentStr = "" // æˆ‘å‘æˆ‘çš„ æˆ‘æ¸…æˆ‘çš„è¯
    const res = await this.myHttp.request(url)
    // æ‹¿åˆ°æœºå™¨äººå›å¤çš„ç»“æœ
    const result = JSON.parse(res.result as string) as ResultClass
    if(result.result === 0) {
      // å†åŠ ä¸€æ¡èŠå¤©è®°å½•
       // éœ€è¦å£°æ˜wantAgentçš„å¯¹è±¡

      let want =  await wantAgent.getWantAgent({
        wants: [{
          bundleName: 'com.itheima.heima_harmony', // åŒ…å
          abilityName: 'HeimaPayAbility', // èƒ½åŠ›åç§°
          moduleName: 'HeimaPay', // æ¨¡å—åç§°
          parameters: {
            order_id: Date.now()
          }
        }],
        // ç‚¹å‡»é€šçŸ¥ ä¼šå¯åŠ¨ability
        operationType: wantAgent.OperationType.START_ABILITY,
        requestCode: 0
      })

      // ç»™æ‰‹æœºåº”ç”¨å‘é€ä¸€æ¡é€šçŸ¥
      let req: notificationManager.NotificationRequest = {
        id: Date.now(),
        content: {
          contentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,   // åŸºæœ¬æ–‡æœ¬ é•¿æ–‡æœ¬
          normal: {
            title: 'æ‚¨çš„è€å©†ç»™ä½ å‘æ¥ä¸€æ¡æ–°çš„æ¶ˆæ¯',
            text: result.content,
            additionalText: 'å¦‚èŠ±çš„ä¿¡æ¯'
          }
        },
         wantAgent: want // ä¸ºé€šçŸ¥æ·»åŠ è¡Œä¸ºæ„å›¾
      }
      notificationManager.publish(req)

      let wifeMessage: MessageItem = {
        avatar: $r("app.media.wife"),
        username: 'æ¯è€è™',
        content: result.content,
        timestamp: Date.now(),
        self: false,
        id: util.generateRandomUUID()
      }
      this.messList.push(wifeMessage) // åŠ å…¥åˆ°åˆ—è¡¨ä¸­

    }else {
      promptAction.showToast({ message: 'æœºå™¨äººå›å¤å¤±è´¥' })
    }
  }

  // èŠå¤©å¯¹è¯æ¡†
  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column () {
        Row() {
          Text("ğŸ¶è€å©†å¤§äºº")
        }
        .height(50)
        // èŠå¤©å¯¹è¯æ¡†
        List({ space: 20 }) {
          // å¾ªç¯ç”ŸæˆèŠå¤©å¯¹è¯
           ForEach(this.messList, (item: MessageItem) => {
             // èŠå¤©ç»„ä»¶
             ListItem() {
               MessageChat({
                 item,
                 delMessage: (id: string) => {
                   // è°ƒç”¨åˆ é™¤é€»è¾‘
                  const index =  this.messList.findIndex(item => item.id === id)
                  this.messList.splice(index, 1)
                 }

               })
             }

           })
        }
        .layoutWeight(1)
        .padding({
          bottom: 80
        })
      }
      .height('100%')
      .position({
        y: this.topY
      })

      // ä¸‹é¢çš„å…ƒç´ 
      Row({ space: 20 }) {
        TextInput({
          text: this.contentStr
        })
          .layoutWeight(1)
          .backgroundColor(Color.White)
          .borderRadius(2)
          .height(40)
          .onChange(value => {
            this.contentStr = value
          })
        Button("å‘é€")
          .height(30)
          .width(60)
          .enabled(!!this.contentStr)
          .onClick(() => {
            // å‘é€æ¶ˆæ¯-å…ˆå°†æˆ‘ä»¬çš„æ¶ˆæ¯æ”¾åœ¨æ¶ˆåˆ—è¡¨é‡Œé¢
            this.sendMessage()
          })

      }
      .width('100%')
      .height(70)
      .padding({
        left: 20,
        right: 20
      })
    }
    .height('100%')
    .backgroundColor("#ededed")
    .onAreaChange((oldArea: Area, newArea: Area) => {
      this.topY = Math.abs(parseFloat(newArea.globalPosition.y.toString()))
    })
  }
}
// èŠå¤©ç»„ä»¶
@Component
struct MessageChat {
  item: Partial<MessageItem>  = {}

  @State
  showDel: boolean = false

  delMessage: (id: string) => void = () => {}

  @Builder
  getDelContent () {
    Button("åˆ é™¤")
      .onClick(() => {
       // this.item.id  // åˆ é™¤é¦–é€‰é¡¹ä¸­çš„å†…å®¹
         this.delMessage(this.item.id)
      })
  }

  build() {
     Row() {
       Image(this.item.avatar)
         .width(40)
         .height(40)
         .borderRadius(6)
       Row () {
         Text(this.item.content)
           .backgroundColor(this.item.self ? "#8bec73" : Color.White)
           .lineHeight(24)
           .fontColor("#0c2803")
           .padding(10)
           .margin({
             left: 10,
             right: 10
           })
           .gesture(LongPressGesture()
             .onAction(() => {
               // è§¦å‘é•¿æŒ‰å›è°ƒ
                 this.showDel = true
             }))
           // .bindPopup(true, abc{
           //   placement: Placement.Top,
           //   builder: this.getDelContent
           // })

         // popup-ç³»ç»Ÿå¼¹çª— å¯ä»¥é’ˆå¯¹æ¯ä¸ªç»„ä»¶è®¾ç½®å¼¹çª—
         if(this.showDel) {
           this.getDelContent()  // è°ƒç”¨
         }
       }
       .layoutWeight(5)
       .justifyContent(this.item.self ? FlexAlign.End : FlexAlign.Start)
       Text().layoutWeight(1)
     }
     .padding({
       left: 20,
       right: 20
     })
    .width('100%')
    .direction(this.item.self ? Direction.Rtl : Direction.Ltr)
  }
}




// æ•°æ®- èƒ½å¤Ÿè¯»å†™é¦–é€‰é¡¹çš„ å·¥å…·æˆ–è€…æ˜¯class

// å®šä¹‰ä¸€æ¡æ¶ˆæ¯çš„ç±»å‹
class MessageItem {
  content: string = "" // èŠå¤©å†…å®¹
  avatar: ResourceStr = "" // ç”¨æˆ·å¤´åƒ
  username: string = "" // ç”¨æˆ·æ˜µç§°
  id: string = "" // æ¶ˆæ¯id
  timestamp: number = 0
  self: boolean = false // æ˜¯å¦æ˜¯è‡ªèº«çš„æ¶ˆæ¯
}
// é¦–é€‰é¡¹æ¥è¯»å–æˆ–è€…è®¾ç½®æ¶ˆæ¯
// å·¥å…·çš„class
class MessageStore {
  // è·å–é¦–é€‰é¡¹ç¤ºä¾‹
  async getStore () {
    return await preferences.getPreferences(getContext(this), "message_store") // ä»“åº“çš„åç§°
  }
  // è®¾ç½®æ¶ˆæ¯
  async setMessageList (json: string) {
    const store = await this.getStore() // å¾—åˆ°å¯¹è±¡
    await store.put("message_list", json) // è®¾ç½®æ•°æ®
    // é€šè¿‡putè®¾ç½®ä¹‹åï¼Œéœ€è¦è°ƒç”¨flushæ–¹æ³• æ‰å¯ä»¥å°†æ•°æ®å­˜å…¥
    await store.flush()
  }
  // è¯»å–æ¶ˆæ¯
  async getMessageList () {
     // è·å–é¦–é€‰é¡¹çš„å¯¹è±¡
    const store = await this.getStore() // å¾—åˆ°å¯¹è±¡
    const data = await store.get("message_list", "[]") as string
    return JSON.parse(data) as MessageItem[]
  }
}

class ResultClass {
  content: string = ""
  result: number =  0
}